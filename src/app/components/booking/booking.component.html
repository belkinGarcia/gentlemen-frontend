<mat-stepper #stepper linear (selectionChange)="onStepChange($event)">
  <mat-step label="Local" [completed]="!!selectedLocation">
    <div class="step-container">
      <div class="step-info" *ngIf="contentService.content$ | async as guide">
        <mat-icon>location_on</mat-icon>
        <h2>{{ guide['step1']?.title }}</h2>
        <p>{{ guide['step1']?.description }}</p>
        <div class="whatsapp-contact-box">
          <h3>{{ guide['contact'].title }}</h3>
          <p>{{ guide['contact'].description }}</p>
          <a [href]="guide['contact'].whatsappLink" mat-flat-button color="accent">
             {{ guide['contact'].whatsappNumber
            }}
          </a>
        </div>
      </div>
      <div class="step-content">
        <div *ngFor="let location of locations" class="location-card" (click)="selectLocation(location)"
          [class.selected]="location.id === selectedLocation?.id">
          <img [src]="location.imageUrl" [alt]="location.name">
          <div class="location-details">
            <strong>{{ location.name }} </strong>
            <span>{{ location.address }}</span>
          </div>
        </div>
      </div>
      <div class="step-summary">
      </div>
    </div>
    <div class="step-actions">
      <button mat-button matStepperNext [disabled]="!selectedLocation">Siguiente</button>
    </div>
  </mat-step>
  <mat-step label="Servicio" [completed]="!!selectedService">
    <div class="step-container">
      <div class="step-info" *ngIf="contentService.content$ | async as guide">
        <mat-icon>auto_stories</mat-icon>
        <h2>{{ guide['step2']?.title }}</h2>
        <p>{{ guide['step2']?.description }}</p>
        <div class="whatsapp-contact-box">
          <h3>{{ guide['contact'].title }}</h3>
          <p>{{ guide['contact'].description }}</p>
          <a [href]="guide['contact'].whatsappLink" mat-flat-button color="accent">
             {{ guide['contact'].whatsappNumber }}
          </a>
        </div>
      </div>
      <div class="step-content">
        <div *ngIf="serviceStepView === 'categories'">
          <div *ngFor="let category of servicesByCategory" class="category-card" (click)="selectCategory(category)">
            <span>{{ category.category }}</span>
            <div class="category-details">
              <span>{{ category.items.length }} Servicios</span>
              <mat-icon>add</mat-icon>
            </div>
          </div>
        </div>
        <div *ngIf="serviceStepView === 'services'">
          <button mat-button (click)="backToCategories()" class="back-button-small">
            <mat-icon>arrow_back</mat-icon> Atr谩s
          </button>
          <div *ngFor="let service of selectedCategoryServices" class="service-card" (click)="selectService(service)"
            [class.selected]="service.id === selectedService?.id">
            <div class="service-details">
              <strong>{{ service.name }}</strong>
              <p>{{ service.description }}</p>
            </div>
            <strong class="service-price">{{ service.price | currency:'S/ ' }}</strong>
          </div>
        </div>
      </div>
      <div class="step-summary" *ngIf="contentService.content$ | async as guide">
        <h4>RESUMEN</h4>
        <div class="summary-item">
          <span>UBICACIN</span>
          <strong>{{ selectedLocation?.name }}</strong>
        </div>
        <div class="summary-item" *ngIf="selectedService">
          <span>SERVICIO</span>
          <strong>{{ selectedService.name }}</strong>
          <span class="sub-text">Duraci贸n: {{ totalDuration }} min</span>
        </div>
        <div class="summary-item total" *ngIf="selectedService">
          <span>PRECIO TOTAL</span>
          <strong>{{ selectedService.price | currency:'S/ ' }}</strong>
        </div>
        <mat-divider></mat-divider>
      </div>
    </div>
    <div class="step-actions">
      <button mat-button matStepperPrevious>Atr谩s</button>
      <button mat-button matStepperNext [disabled]="!selectedService">Siguiente</button>
    </div>
  </mat-step>
  <mat-step label="Barbero" [completed]="!!selectedBarber">
    <div class="step-container">
      <div class="step-info" *ngIf="contentService.content$ | async as guide">
        <mat-icon>content_cut</mat-icon>
        <h2>{{ guide['step3']?.title }}</h2>
        <p>{{ guide['step3']?.description }}</p>
        <div class="whatsapp-contact-box">
          <h3>{{ guide['contact'].title }}</h3>
          <p>{{ guide['contact'].description }}</p>
          <a [href]="guide['contact'].whatsappLink" mat-flat-button color="accent">
             {{ guide['contact'].whatsappNumber }}
          </a>
        </div>
      </div>
      <div class="step-content">
        <app-barber-selector [barbers]="barbersForLocation" [selectedBarberId]="selectedBarber?.id"
          (selectionChange)="selectBarber($event)">
        </app-barber-selector>
      </div>
      <div class="step-summary" *ngIf="contentService.content$ | async as guide">
        <h4>RESUMEN</h4>
        <div class="summary-item">
          <span>UBICACIN</span>
          <strong>{{ selectedLocation?.name }}</strong>
        </div>
        <div class="summary-item">
          <span>SERVICIO</span>
          <strong>{{ selectedService?.name }}</strong>
          <span class="sub-text">Duraci贸n: {{ totalDuration }} min</span>
        </div>
        <div class="summary-item" *ngIf="selectedBarber">
          <span>BARBERO</span>
          <strong>{{ selectedBarber?.name }}</strong>
        </div>
        <div class="summary-item total">
          <span>PRECIO TOTAL</span>
          <strong>{{ selectedService?.price | currency:'S/ ' }}</strong>
        </div>
        <mat-divider></mat-divider>
      </div>
    </div>
    <div class="step-actions">
      <button mat-button matStepperPrevious>Atr谩s</button>
      <button mat-button matStepperNext [disabled]="!selectedBarber">Siguiente</button>
    </div>
  </mat-step>
  <mat-step label="Fecha y Hora" [completed]="!!selectedDate && !!selectedTime">
    <div class="step-container">
      <div class="step-info" *ngIf="contentService.content$ | async as guide">
        <mat-icon>calendar_today</mat-icon>
        <h2>{{ guide['step4']?.title }}</h2>
        <p>{{ guide['step4']?.description }}</p>
        <div class="whatsapp-contact-box">
          <h3>{{ guide['contact'].title }}</h3>
          <p>{{ guide['contact'].description }}</p>
          <a [href]="guide['contact'].whatsappLink" mat-flat-button color="accent">
             {{ guide['contact'].whatsappNumber }}
          </a>
        </div>
      </div>
      <div class="step-content">
        <mat-calendar [selected]="selectedDate" (selectedChange)="onDateSelect($event)" [dateClass]="dateClass"
          [minDate]="minDate">
        </mat-calendar>
        <div *ngIf="selectedDate" class="time-slots-container">
          <h4>Elija la hora de la cita para {{ selectedDate | date: 'longDate' }}</h4>
          <div *ngIf="availableTimes.length > 0; else noTimes" class="time-slots-grid">
            <button *ngFor="let time of availableTimes" mat-stroked-button (click)="selectTime(time)"
              [class.selected]="time === selectedTime">
              {{ time }}
            </button>
          </div>
          <ng-template #noTimes>
            <div class="no-times-message">
              No disponible
            </div>
          </ng-template>
        </div>
      </div>
      <div class="step-summary" *ngIf="contentService.content$ | async as guide">
        <h4>RESUMEN</h4>
        <div class="summary-item">
          <span>UBICACIN</span>
          <strong>{{ selectedLocation?.name }}</strong>
        </div>
        <div class="summary-item">
          <span>SERVICIO</span>
          <strong>{{ selectedService?.name }}</strong>
          <span class="sub-text">Duraci贸n: {{ totalDuration }} min</span>
        </div>
        <div class="summary-item">
          <span>BARBERO</span>
          <strong>{{ selectedBarber?.name }}</strong>
        </div>
        <div class="summary-item" *ngIf="selectedDate">
          <span>FECHA</span>
          <strong>{{ selectedDate | date:'longDate' }}</strong>
        </div>
        <div class="summary-item total">
          <span>PRECIO TOTAL</span>
          <strong>{{ selectedService?.price | currency:'S/ ' }}</strong>
        </div>
        <mat-divider></mat-divider>
      </div>
    </div>
    <div class="step-actions">
      <button mat-button matStepperPrevious>Atr谩s</button>
      <button mat-button matStepperNext [disabled]="!selectedTime">Siguiente</button>
    </div>
  </mat-step>
<mat-step label="Informaci贸n" [completed]="informationForm.valid">
    <div class="step-container">
      <div class="step-info" *ngIf="contentService.content$ | async as guide">
        <mat-icon>person</mat-icon>
        <h2>{{ guide['step5']?.title }}</h2>
        <p>{{ guide['step5']?.description }}</p>
        <div class="whatsapp-contact-box">
          <h3>{{ guide['contact'].title }}</h3>
          <p>{{ guide['contact'].description }}</p>
          <a [href]="guide['contact'].whatsappLink" mat-flat-button color="accent">
             {{ guide['contact'].whatsappNumber }}
          </a>
        </div>
      </div>
      
      <div class="step-content">
        
        <div *ngIf="!isLoggedIn">
           <app-auth-page [displayMode]="'tabs'" 
                          (loginSuccess)="handleAuthentication($event)"
                          (registerSuccess)="handleAuthentication($event)">
           </app-auth-page>
        </div>

        <div *ngIf="isLoggedIn && !informationForm.valid" class="manual-completion-form">
            <div class="alert-box" style="background: #fff3cd; color: #856404; padding: 10px; margin-bottom: 15px; border-radius: 4px; display: flex; align-items: center;">
              <mat-icon style="margin-right: 8px;">warning</mat-icon>
              <span>Faltan algunos datos. Por favor compl茅talos para continuar.</span>
            </div>
            
            <form [formGroup]="informationForm" class="booking-form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <mat-form-field appearance="outline">
                <mat-label>Nombre</mat-label>
                <input matInput formControlName="firstName">
                <mat-error *ngIf="informationForm.get('firstName')?.hasError('required')">Requerido</mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Apellido</mat-label>
                <input matInput formControlName="lastName">
                 <mat-error *ngIf="informationForm.get('lastName')?.hasError('required')">Requerido</mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>DNI</mat-label>
                <input matInput formControlName="dni" placeholder="Ingresa tu DNI">
                <mat-error *ngIf="informationForm.get('dni')?.hasError('required')">Requerido</mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Celular</mat-label>
                <input matInput formControlName="phone" placeholder="999 999 999">
                <mat-error *ngIf="informationForm.get('phone')?.hasError('required')">Requerido</mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline" style="grid-column: 1 / -1; width: 100%;">
                <mat-label>Correo electr贸nico</mat-label>
                <input matInput formControlName="email" readonly>
              </mat-form-field>
            </form>
        </div>

        <div *ngIf="isLoggedIn && informationForm.valid" class="authenticated-loading-view" style="text-align: center; padding: 2rem;">
            <h3>Usuario autenticado: {{ informationForm.get('firstName')?.value }}</h3>
            <p>Datos verificados. Creando reserva...</p>
            <mat-spinner diameter="40" style="margin: 0 auto;"></mat-spinner>
        </div>

      </div>

      <div class="step-summary" *ngIf="contentService.content$ | async as guide">
        <h4>RESUMEN</h4>
        <div class="summary-item">
          <span>UBICACIN</span>
          <strong>{{ selectedLocation?.name }}</strong>
        </div>
        <div class="summary-item">
          <span>SERVICIO</span>
          <strong>{{ selectedService?.name }}</strong>
          <span class="sub-text">Duraci贸n: {{ totalDuration }} min</span>
        </div>
        <div class="summary-item">
          <span>BARBERO</span>
          <strong>{{ selectedBarber?.name }}</strong>
        </div>
        <div class="summary-item" *ngIf="selectedDate">
          <span>FECHA</span>
          <strong>{{ selectedDate | date:'longDate' }}</strong>
        </div>
        <div class="summary-item" *ngIf="selectedTime">
          <span>HORA</span>
          <strong>{{ selectedTime }}</strong>
        </div>
        <div class="summary-item total">
          <span>PRECIO TOTAL</span>
          <strong>{{ selectedService?.price | currency:'S/ ' }}</strong>
        </div>
        <mat-divider></mat-divider>
      </div>
    </div>

    <div class="step-actions">
      <button mat-button matStepperPrevious>Atr谩s</button>
      
      <button mat-button (click)="confirmAppointment()" 
              [disabled]="informationForm.invalid" 
              *ngIf="isLoggedIn">
        Siguiente
      </button>
    </div>
  </mat-step>
  <mat-step label="Confirmaci贸n">
    <div class="step-container confirmation-view">
      <div class="step-info" *ngIf="contentService.content$ | async as guide">
        <mat-icon class="success-icon">verified_user</mat-icon>
        <h2>{{ guide['step6']?.title }}</h2>
        <p>{{ guide['step6']?.description }}</p>
      </div>
      <div class="step-content confirmation-details">
        <div class="confirmation-header">
        </div>
        <span class="confirmation-label">CONFIRMATION #</span>
        <h2 class="confirmation-number">{{ confirmationNumber }}</h2>
        <div class="confirmation-actions">
          <button mat-stroked-button (click)="downloadConfirmationAsPDF()">
            <mat-icon>print</mat-icon> Imprimir
          </button>
          <button mat-flat-button color="primary" (click)="closeAndNavigateToReservations()">
            <mat-icon>visibility</mat-icon>
            Ver mis reservas
          </button>
        </div>
        <div class="detail-section">
          <h4>Informaci贸n de la cita</h4>
          <div class="detail-grid">
            <div class="grid-item">
              <span class="grid-label">FECHA:</span>
              <strong class="grid-value">{{ selectedDate | date:'d MMM, yyyy' }}</strong>
            </div>
            <div class="grid-item">
              <span class="grid-label">HORA:</span>
              <strong class="grid-value">{{ selectedTime }}</strong>
            </div>
            <div class="grid-item full-width">
              <span class="grid-label">UBICACIN:</span>
              <strong class="grid-value">{{ selectedLocation?.address }}</strong>
            </div>
            <div class="grid-item">
              <span class="grid-label">BARBERO:</span>
              <strong class="grid-value">{{ selectedBarber?.name }}</strong>
            </div>
            <div class="grid-item full-width">
              <span class="grid-label">SERVICIO:</span>
              <strong class="grid-value">{{ selectedService?.name }} ({{ totalDuration }} min)</strong>
            </div>
          </div>
        </div>
        <div class="detail-section">
          <h4>Informaci贸n del cliente</h4>
          <div class="detail-grid">
            <div class="grid-item">
              <span class="grid-label">NOMBRE:</span>
              <strong class="grid-value">{{ informationForm.get('firstName')?.value }} {{
                informationForm.get('lastName')?.value }}</strong>
            </div>
            <div class="grid-item">
              <span class="grid-label">TELFONO:</span>
              <strong class="grid-value">{{ informationForm.get('phone')?.value }}</strong>
            </div>
            <div class="grid-item full-width">
              <span class="grid-label">CORREO ELECTRNICO:</span>
              <strong class="grid-value">{{ informationForm.get('email')?.value }}</strong>
            </div>
          </div>
        </div>
        <div class="detail-section">
          <h4>Informaci贸n de pago</h4>
          <div class="detail-grid">
            <div class="grid-item">
              <span class="grid-label">PRECIO:</span>
              <strong class="grid-value">{{ selectedService?.price | currency:'S/ ' }}</strong>
            </div>
          </div>
        </div>
      </div>
    </div>
  </mat-step>
</mat-stepper>
<div class="pdf-ticket-wrapper">
  <div id="pdf-ticket" class="pdf-ticket-container">
    <h3>Confirmaci贸n de la cita</h3>
    <p class="pdf-label">Confirmation #</p>
    <p class="pdf-number">{{ confirmationNumber }}</p>
    <div class="pdf-section">
      <h4>Informaci贸n de la cita</h4>
      <div class="pdf-grid">
        <div class="grid-item">
          <span>Fecha:</span> <strong>{{ selectedDate | date:'d MMM, yyyy' }}</strong>
        </div>
        <div class="grid-item">
          <span>Hora:</span> <strong>{{ selectedTime }}</strong>
        </div>
        <div class="grid-item full-width">
          <span>Ubicaci贸n:</span> <strong>{{ selectedLocation?.address }}</strong>
        </div>
        <div class="grid-item">
          <span>Barbero:</span> <strong>{{ selectedBarber?.name }}</strong>
        </div>
        <div class="grid-item full-width">
          <span>Servicio:</span> <strong>{{ selectedService?.name }} ({{ totalDuration }} min)</strong>
        </div>
      </div>
    </div>
    <div class="pdf-section">
      <h4>Informaci贸n del cliente</h4>
      <div class="pdf-grid">
        <div class="grid-item">
          <span>Nombre:</span> <strong>{{ informationForm.get('firstName')?.value }} {{
            informationForm.get('lastName')?.value }}</strong>
        </div>
        <div class="grid-item">
          <span>Tel茅fono:</span> <strong>{{ informationForm.get('phone')?.value }}</strong>
        </div>
        <div class="grid-item full-width">
          <span>Correo electr贸nico:</span> <strong>{{ informationForm.get('email')?.value }}</strong>
        </div>
      </div>
    </div>
    <div class="pdf-section">
      <h4>Informaci贸n de pago</h4>
      <div class="pdf-grid">
        <div class="grid-item">
          <span>Precio:</span> <strong>{{ selectedService?.price | currency:'S/ ' }}</strong>
        </div>
      </div>
    </div>
  </div>
</div>